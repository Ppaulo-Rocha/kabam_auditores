
var kanbanBoard = document.getElementById('kanban-board');
var todoColumn = document.getElementById('todo');
var inProgressColumn = document.getElementById('in-progress');
var doneColumn = document.getElementById('done');
var kanbanColumns = [todoColumn, inProgressColumn, doneColumn];
var drake = dragula(kanbanColumns, {
    moves: function (el, source, handle, sibling) {
        return handle.classList.contains('kanban-item');
    }
});


function addToLog(message) {
    var logTerminal = document.getElementById('log-terminal');
    var logMessage = document.createElement('div');
    logMessage.textContent = message;
    logTerminal.appendChild(logMessage);
}

function checkAuditStatus() {
    var doneItems = Array.from(doneColumn.getElementsByClassName('kanban-item'));
    var isAuditComplete = doneItems.length === 29;

    if (isAuditComplete) {
        // Adicionar a classe 'completed' aos itens conclu√≠dos
        doneItems.forEach(function (item) {
            item.classList.add('completed');
        });

        // Remover a classe 'dragula-no-drag' para permitir arrastar novamente
        drake.containers.forEach(function (container) {
            container.classList.remove('dragula-no-drag');
        });

        // Aguardar 3 segundos antes de alertar a aprova√ß√£o
        setTimeout(function () {
            // Exibir caixa de di√°logo SweetAlert2 com mensagem de aprova√ß√£o
            const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                    confirmButton: 'btn btn-success',
                },
                buttonsStyling: false,
                theme: 'dark', // Adiciona o tema dark
            });

            swalWithBootstrapButtons.fire({
                title: 'Auditoria Aprovada!',
                text: 'Seguindo para a pr√≥xima etapa...',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                // Ap√≥s fechar o alerta, recarregar a p√°gina
                location.reload();
            });             
           
        }, 3000);
    }
}




drake.on('drop', function (el, target, source, sibling) {
    console.log('Item dropped:', el.textContent, 'from', source.id, 'to', target.id);
    checkAuditStatus(target);

    if (target === inProgressColumn) {
        // Aguardar 2 segundos antes de abrir o popup de reprova√ß√£o
        setTimeout(function () {
            openRejectionFormPopup(el.textContent);
        }, 2000);
    }
});

function openRejectionFormPopup(itemText) {    
    const swalWithBootstrapButtons = Swal.mixin({
      customClass: {
        confirmButton: 'btn btn-success',
        cancelButton: 'btn btn-danger',
      },
      buttonsStyling: false,
    });
  
    swalWithBootstrapButtons.fire({
      title: 'REPROVADO!',
      text: `Deseja abrir o formul√°rio de reprova√ß√£o para o item "${itemText}"?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sim, abrir formul√°rio',
      cancelButtonText: 'N√£o, cancelar',
      reverseButtons: true,
    }).then((result) => {
      if (result.isConfirmed) {        
        var formPopup = window.open('', 'Rejection Form', 'width=640,height=1567');
  
        if (formPopup) {
          formPopup.document.write(
            '<iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdVenAYGiR-XGzIAcDr2K-SzvYTSiApdBuiPwz-slX4zFV4Ug/viewform?embedded=true" width="640" height="1350" frameborder="0" marginheight="0" marginwidth="0">Carregando‚Ä¶</iframe>'
          );
        } else {          
          Swal.fire({
            title: 'Erro ao abrir o formul√°rio!',
            text: 'O bloqueio de pop-ups pode estar impedindo a abertura do formul√°rio. Verifique as configura√ß√µes do seu navegador.',
            icon: 'error',
          });
        }
      } else {        
        Swal.fire({
          title: 'Opera√ß√£o Cancelada',
          text: 'Item reprovado, mas formul√°rio n√£o aberto.',
          icon: 'info',
        });
      }
    });
  }function openRejectionFormPopup(itemText) {  
  document.body.classList.add('dark');  
  const swalWithBootstrapButtons = Swal.mixin({
    customClass: {
      confirmButton: 'btn btn-outline-warning m-2',
      cancelButton: 'btn btn-outline-danger',
    },
    buttonsStyling: false,
  });

  swalWithBootstrapButtons.fire({
    title: 'Item Reprovado ü´†üò•üìù',
    text: `Deseja abrir o formul√°rio de reprova√ß√£o para o item "${itemText}"?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Sim, abrir formul√°rio',
    cancelButtonText: 'N√£o, cancelar',
    reverseButtons: true,
  }).then((result) => {
    // Removendo a classe 'dark' ao corpo do documento ap√≥s a conclus√£o da a√ß√£o
    document.body.classList.remove('dark');

    if (result.isConfirmed) {
      
      var formPopup = window.open('', 'Rejection Form', 'width=640,height=1567');

      if (formPopup) {
        formPopup.document.write(
          '<iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdVenAYGiR-XGzIAcDr2K-SzvYTSiApdBuiPwz-slX4zFV4Ug/viewform?embedded=true" width="640" height="1350" frameborder="0" marginheight="0" marginwidth="0">Carregando‚Ä¶</iframe>'
        );
      } else {
        
        Swal.fire({
          title: 'Erro ao abrir o formul√°rio!',
          text: 'O bloqueio de pop-ups pode estar impedindo a abertura do formul√°rio. Verifique as configura√ß√µes do seu navegador.',
          icon: 'error',
        });
      }
    } else {
      
      Swal.fire({
        title: 'Opera√ß√£o Cancelada',
        text: 'Item reprovado, mas formul√°rio n√£o aberto.',
        icon: 'info',
      });
    }
  });
}

  
  

var restartButton1 = document.getElementById('restart-button1');
restartButton1.addEventListener('click', function () {
       drake.containers.forEach(function (container) {
        container.classList.add('dragula-no-drag');
    });

    
    var doneItems = Array.from(doneColumn.getElementsByClassName('kanban-item'));
    doneItems.forEach(function (item) {
        item.classList.remove('completed');
    });
});


function reloadPage() {
    location.reload();
}
